(self.webpackChunktiny_files=self.webpackChunktiny_files||[]).push([[605],{605:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>F});var s=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{class:{blur:t.dragging&&!t.suppressDrag},attrs:{id:"tiny-browse"},on:{dragover:t.dragOver}},[i("h1",{staticClass:"title"},[t._v("tiny-files browser")]),t._v(" "),i("button",{directives:[{name:"show",rawName:"v-show",value:t.canUpload,expression:"canUpload"}],staticClass:"has-background-info",attrs:{id:"upload-fab"},on:{click:function(e){return t.upload()}}},[i("b-icon",{attrs:{icon:"file-upload"}})],1),t._v(" "),t.paths?i("tiny-explorer",{attrs:{paths:t.paths,mapLink:t.getLink,rootRoute:"/browse",rootName:t.familiarLayout&&t.personal?"personal":"root"},on:{"update:dir":function(e){t.dir=e},open:t.open,delete:t.remove,copy:t.copy,move:t.move,share:t.share,dragging:function(e){t.suppressDrag=!0},draggingEnd:function(){t.suppressDrag=!1,t.throttledDragover.flush()}}}):t._e(),t._v(" "),t.dragging&&!t.suppressDrag?i("section",{attrs:{id:"upload-section"},on:{dragover:function(e){return e.preventDefault(),t.throttledDragover()}}},[i("b-field",[i("b-upload",{attrs:{multiple:"","drag-drop":""},model:{value:t.dropFiles,callback:function(e){t.dropFiles=e},expression:"dropFiles"}},[i("section",{staticClass:"section"},[i("div",{staticClass:"content has-text-centered"},[i("p",[i("b-icon",{attrs:{icon:"upload",size:"is-large"}})],1),t._v(" "),i("p",[t._v("drop your files here or click to upload (or "),i("a",{on:{click:function(e){e.preventDefault(),t.dragging=!1}}},[t._v("cancel")]),t._v(")")])])])])],1)],1):t._e(),t._v(" "),i("b-loading",{attrs:{active:t.working}})],1)};s._withStripped=!0;var a=i(3987),r=i(6013),o=i(7343),l=i(9461),n=i(7853),c=i(7670),p=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"tiny-upload modal-card",on:{dragover:function(e){return e.preventDefault(),t.throttledDragover()}}},[i("header",{staticClass:"modal-card-head"},[i("p",{staticClass:"modal-card-title"},[i("span",[t._v("upload filesÂ ")]),i("span",{staticStyle:{"font-size":"1rem"}},[t._v("- "+t._s(t.uploadDir))])]),t._v(" "),i("button",{staticClass:"delete",attrs:{type:"button"},on:{click:function(e){return t.$emit("close")}}})]),t._v(" "),i("section",{staticClass:"modal-card-body"},[t.fileList.length?[i("div",{staticClass:"files"},[t._l(t.fileList,(function(e,s){return i("div",{key:"file-"+s,staticClass:"file-entry"},[i("b-icon",{style:{color:e.fileIconColor},attrs:{icon:e.fileIcon,title:e.type}}),t._v(" "),i("span",[t._v(t._s(e.file.name))]),t._v(" "),i("button",{staticClass:"delete",attrs:{type:"button"},on:{click:function(i){return t.remFile(e.file)}}})],1)})),t._v(" "),i("div",{key:"file-"+t.fileList.length,staticClass:"file-entry",staticStyle:{"margin-top":"0.5rem"}},[i("b-icon",{attrs:{icon:"file-multiple has-text-info",title:""}}),t._v(" "),i("span",{staticStyle:{"font-style":"italic",opacity:"0.5"}},[t._v("drop files here, or click the button below to upload")]),t._v(" "),i("span")],1)],2)]:i("b-field",[i("b-upload",{attrs:{multiple:"","drag-drop":""},model:{value:t.localFiles,callback:function(e){t.localFiles=e},expression:"localFiles"}},[i("section",{staticClass:"section"},[i("div",{staticClass:"content has-text-centered"},[i("p",[i("b-icon",{attrs:{icon:"upload",size:"is-large"}})],1),t._v(" "),i("p",[t._v("drop your files here or click to upload")])])])])],1)],2),t._v(" "),i("footer",{staticClass:"modal-card-foot"},[i("b-field",{directives:[{name:"show",rawName:"v-show",value:!t.status,expression:"!status"}],staticClass:"file is-info"},[i("b-upload",{attrs:{multiple:""},model:{value:t.localFiles,callback:function(e){t.localFiles=e},expression:"localFiles"}},[i("span",{staticClass:"file-cta"},[i("b-icon",{staticClass:"file-icon",attrs:{icon:"upload"}}),t._v(" "),i("span",{staticClass:"file-label"},[t._v("upload files")])],1)])],1),t._v(" "),i("span",{directives:[{name:"show",rawName:"v-show",value:t.status,expression:"status"}]},[t._v(t._s(t.status)+" ("+t._s(t.progress)+"%)")]),t._v(" "),i("div",{staticStyle:{"flex-grow":"1"}}),t._v(" "),i("b-button",{attrs:{label:"close",disabled:t.working},on:{click:function(e){return t.$emit("close")}}}),t._v(" "),i("b-button",{attrs:{type:"is-primary",label:"upload",disabled:t.working||!t.fileList.length,loading:t.working},on:{click:function(e){return t.upload()}}})],1),t._v(" "),t.dragging?i("section",{attrs:{id:"upload-section"},on:{dragover:function(e){return e.preventDefault(),t.throttledDragover()}}},[i("b-field",[i("b-upload",{attrs:{multiple:"","drag-drop":""},model:{value:t.localFiles,callback:function(e){t.localFiles=e},expression:"localFiles"}},[i("section",{staticClass:"section"},[i("div",{staticClass:"content has-text-centered"},[i("p",[i("b-icon",{attrs:{icon:"upload",size:"is-large"}})],1),t._v(" "),i("p",[t._v("Drop your files here or click to upload (or "),i("a",{on:{click:function(e){e.preventDefault(),t.dragging=!1}}},[t._v("cancel")]),t._v(")")])])])])],1)],1):t._e()])};p._withStripped=!0;var h=i(4357);const u=c.Z.component("tiny-upload",{props:{files:{type:Array,required:!1,default:()=>[]},dir:{type:String,required:!1,default:()=>"/"},familiar:{type:Boolean,required:!1,default:!1}},data:()=>({working:!1,remFiles:[],localFiles:[],uploadDir:"/",status:"",progress:0,dragging:!1,throttledDragover:null}),computed:{fileList(){return[...this.files.filter(((t,e)=>!this.remFiles.includes(e))),...this.localFiles].map((t=>{const e=t.type;return{file:t,type:e,...(0,h.LP)(e)}}))}},watch:{dir(t,e){t&&t!==e&&(this.uploadDir=t)}},mounted(){this.uploadDir=this.dir||"/",this.throttledDragover=(0,o.debounce)((()=>this.dragging=!this.dragging),333,{leading:!0,trailing:!0})},methods:{async upload(){if(!this.working){this.working=!0,this.uploadDir.endsWith("/")||(this.uploadDir+="/"),this.familiar&&(this.uploadDir.startsWith("/public")?this.uploadDir=l.Z.publicScope+this.uploadDir.slice("/public".length):this.uploadDir=l.Z.privateScope+this.uploadDir);for(const t of this.fileList)this.status="uploading "+t.file.name+"...",await n.Z.files.write(this.uploadDir+t.file.name,await t.file.arrayBuffer(),t.type,(t=>this.progress=Math.round(1e4*t.loaded/t.total)/100));this.status="",this.working=!1,this.$emit("close",!0)}},remFile(t){const e=this.files.indexOf(t);e>=0?this.remFiles.push(e):this.localFiles=this.localFiles.filter((e=>e!==t))}}});var d=i(1900),f=(0,d.Z)(u,p,[],!1,null,null,null);f.options.__file="src/components/upload/upload.vue";const g=f.exports;var m,v=new Uint8Array(16);function y(){if(!m&&!(m="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return m(v)}const b=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;const w=function(t){return"string"==typeof t&&b.test(t)};for(var _=[],k=0;k<256;++k)_.push((k+256).toString(16).substr(1));const Z=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=(_[t[e+0]]+_[t[e+1]]+_[t[e+2]]+_[t[e+3]]+"-"+_[t[e+4]]+_[t[e+5]]+"-"+_[t[e+6]]+_[t[e+7]]+"-"+_[t[e+8]]+_[t[e+9]]+"-"+_[t[e+10]]+_[t[e+11]]+_[t[e+12]]+_[t[e+13]]+_[t[e+14]]+_[t[e+15]]).toLowerCase();if(!w(i))throw TypeError("Stringified UUID is invalid");return i};const D=function(t,e,i){var s=(t=t||{}).random||(t.rng||y)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,e){i=i||0;for(var a=0;a<16;++a)e[i+a]=s[a];return e}return Z(s)},C=c.Z.component("tiny-browse",{data(){const t={working:!1,paths:null,rawPaths:[],dir:"/",suppressDrag:!1,dropFiles:[],dragging:!1,throttledDragover:null,getLink:e=>t.familiarLayout&&t.personal?e.startsWith("/public")?n.Z.files.getReadUrl(l.Z.publicScope+e.slice("/public".length)):n.Z.files.getReadUrl(l.Z.privateScope+e):n.Z.files.getReadUrl(e),familiarLayout:!0,personal:!l.Z.storeScopes.includes("/")&&2===l.Z.storeScopes.length};return t},computed:{canUpload(){return this.personal&&this.familiarLayout||this.dir&&Boolean(l.Z.storeScopes.find((t=>this.dir.startsWith(t))))}},watch:{dropFiles(t,e){t.length&&(this.upload(t),this.dropFiles=[])}},async mounted(){this.throttledDragover=(0,o.debounce)((()=>this.dragging=!this.dragging),333,{leading:!0,trailing:!0}),await this.refresh()},methods:{dragOver(t){this.suppressDrag||(t.preventDefault(),t.dataTransfer.dropEffect="copy"),this.throttledDragover()},async refresh(){if(!this.working){this.working=!0;try{const t=async t=>{const e={};let i;do{const s=await n.Z.files.listFiles(t,!0,i);"/"===t&&(t="");for(const i in s.entries)e[t+i]=s.entries[i];i=s.page||void 0}while(i);return e},e=await Promise.all(l.Z.storeScopes.map(t)).then((t=>t.reduce(((t,e)=>Object.assign(t,e)))));this.rawPaths=Object.keys(e);let i=[];for(const t of this.rawPaths)i.push(Object.assign({},e[t],{path:t}));if(this.familiarLayout&&this.personal){const t=l.Z.privateScope,e=l.Z.publicScope;i=i.filter((i=>!i.path.startsWith(t+"/public")&&!i.path.startsWith(e+"/shares")));for(const s of i)s.path.startsWith(t)?s.path=s.path.slice(t.length):s.path.startsWith(e)&&(s.path="/public"+s.path.slice(e.length));this.rawPaths.find((t=>t.startsWith(e)))||i.push({path:"/public/null",name:"Nothing here...",type:"none",size:0,modified:0})}else if(l.Z.storeScopes.includes("/"))this.rawPaths.find((t=>t.startsWith("/public")))||i.push({path:"/public/null",name:"Nothing here...",type:"none",size:0,modified:0});else for(const t of l.Z.storeScopes)this.rawPaths.find((e=>e.startsWith(t)))||i.push({path:"/"===t?"/null":t+"/null",name:"Nothing here...",type:"none",size:0,modified:0});this.paths=i}catch(t){console.error("error refreshing")}this.working=!1}},open(t){window.open(this.getLink(t),"__blank")},mapPath(t){return this.familiarLayout&&this.personal?/^\/public/.test(t)?l.Z.publicScope+t.slice("/public".length):l.Z.privateScope+t:t},mapPaths(t){return this.familiarLayout&&this.personal&&(t=t.map((t=>/^\/public/.test(t)?l.Z.publicScope+t.slice("/public".length):l.Z.privateScope+t))),t},async remove({type:t,paths:e,path:i}){if(!this.working)return this.working=!0,e=i?[this.mapPath(i)]:this.mapPaths(e),"file"!==t?await Promise.all(this.rawPaths.filter((t=>e.find((e=>t.startsWith(e))))).map((t=>n.Z.files.delete(t).catch((()=>{}))))):await n.Z.files.delete(e[0]).catch((()=>{})),this.working=!1,this.refresh()},async _copy({from:t,paths:e,to:i}){const s=this.mapPaths(e),a=this.mapPaths(e.map((e=>i+e.slice(t.length))));if(s[0]===a[0])return[];return await Promise.all(e.map(((t,e)=>(async(t,e)=>{const i=await n.Z.files.read(t,"blob");await n.Z.files.write(e,await i.arrayBuffer())})(s[e],a[e]).catch((()=>{}))))),s},async copy({from:t,paths:e,to:i}){if(!this.working&&t!==i&&0!==e.length)return this.working=!0,await this._copy({from:t,paths:e,to:i}),this.working=!1,this.refresh()},async move({from:t,paths:e,to:i}){if(this.working||t===i)return;this.working=!0;const s=await this._copy({from:t,paths:e,to:i});return await Promise.all(s.map((t=>n.Z.files.delete(t).catch((()=>{}))))),this.working=!1,this.refresh()},async share(t){if(this.working)return;this.working=!0;let e="";if(!(t instanceof Array)){if(!t.startsWith("/public"))return;const e=this.mapPath(t);t=this.rawPaths.filter((t=>t.startsWith(e)))}if((t=this.mapPaths(t.filter((t=>t.startsWith("/public"))))).length){if(t.length>1){const i={entries:t};let s=D(),a=l.Z.publicScope+"/shares/"+s+".json";for(;this.rawPaths.includes(a=l.Z.publicScope+"/shares/"+s+".json");)s=D();const r=new TextEncoder;await n.Z.files.write(a,r.encode(JSON.stringify(i)),"application/json"),e=location.origin+("hash"===this.$router.mode?"#":"")+"/explore?store="+l.Z.storeUrl+"&user="+l.Z.storeUser.username+"&share="+s}else e=n.Z.files.getPublicReadUrl("asdf",t[0].slice("/public".length));return a.q.prompt({title:"share item(s)",message:"here is the link to share:",inputAttrs:{readonly:!0,value:e},cancelText:"cancel",confirmText:"okay"}),this.working=!1,this.refresh()}},upload(t){r.NK.open({component:g,hasModalCard:!0,props:{files:t,familiar:this.familiarLayout&&this.personal,dir:this.dir},onCancel:()=>this.refresh(),events:{close:t=>t?this.refresh():null}})}}});var S=(0,d.Z)(C,s,[],!1,null,null,null);S.options.__file="src/pages/browse/browse.vue";const F=S.exports}}]);